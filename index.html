<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
  </head>
  <body style="width:800px;margin:0px auto">
    <div id="page-first" style="display:none">
      <div style="background:grey;width:650px;float:right;margin-top:50px">
        <p style="margin-left:30px"><input id="email1" placeholder="Email"/>
            <input id="pwd1" placeholder="Password" type="password" />
            <input type="submit" value="Sign in" onclick="signIn();"/></p>
        <p style="margin-left:30px"><input id="remember" type="checkbox"/>Remember me | <a onclick="openForgotDialog();">Forgot password?</a></p>
      </div>
      <p style="clear:right; float:left; width:300px"><strong>Welcome to the web.</strong> Connect with friends and the world around you.
      </p>
      <ul style="clear:left; float:left; width:300px">
        <li>See photos and updates</li>
        <li>Share what's new</li>
        <li>Find more</li>
      </ul>
      <div style="background:grey; width:350px;float:right;clear:right;margin-top:50px">
        <p style="margin-left:30px"><strong>New to the web?</strong> Sign up</p>
        <p style="margin-left:30px"><input placeholder="Full name" id="fn" /></p>
        <p style="margin-left:30px"><input placeholder="Email" id="email" /></p>
        <p style="margin-left:30px"><input type="password" placeholder="Password" id="pwd" /></p>
        <p style="margin-right:30px;float:right"><a href="more.html">learn more</a>
             <input type="submit" value="Sign up for the web" onclick="step1();"/></p>
      </div>
    </div>
    <div style="display:none" id="page-forgot">
      <div style="background:grey;width:350px;float:right;margin-top:50px">
        <p style="margin-left:30px"><input id="email_forgot" placeholder="Email"/></p>
        <p style="margin-left:30px"><input type="submit" value="regen" onclick="genCaptcha();" />
            <img id="captcha_forgot" />
            <input id="solution_forgot" />
            <input type="submit" value="Send reminder" onclick="startForgotPassword();"/></p>
      </div>
    </div>
    <div style="display:none" id="page-resetPwd">
      <div style="background:grey;width:350px;float:right;margin-top:50px">
        <p style="margin-left:30px"><input id="password_reset" type="password" placeholder="New password"/></p>
        <p style="margin-left:30px"><input type="submit" value="Reset password" onclick="completeForgotPassword();"/></p>
      </div>
    </div>
    <div style="display:none" id="page-second">
      <p><input placeholder="yourname" id="host" /><strong>.un.ht</strong></p>
      <p><strong>Terms of Service:</strong></p>
      <p><textarea id="tos" readOnly=true>Be nice!</textarea></p>
      <p><input type="checkbox" id="agree">I agree to the Terms of Service</p>
      <input type="submit" value="regen" onclick="genCaptcha();" />
      <img id="captcha" />
      <input id="solution" />
      <input type="submit" value="register" onclick="register();" />
    </div>
    <div style="display:none" id="page-settings">
      <h1 id="welcome">Welcome to your unhosted customer account <input type="submit" value="logout" onclick="logout();" /></h1>
      <p>
        <input id="settingsEmail" /><input type="submit" value="Resend validation email" id="validateEmail"/>
        <input type="submit" value="Change" onclick="startChangeEmail();" />
      </p>
      <p>
        Current: <input id="currentPwd" type="password" />
        New: <input id="newPwd" type="password" />
        <input type="submit" value="Change password" onclick="changePwd();" />
        <input type="submit" value="Delete account" style="background:red" onclick="deleteAccount();" />
      </p>
    </div>
  </body>
  <script src="backtofront.js"></script>
  <script>
    var pages = ['first', 'forgot', 'resetPwd' 'second', 'settings', 'cms', 'auth'];
    function showPage(id) {
      for(var i=0; i<pages.length; i++) {
        $('page-'+pages[i]).style.display=(pages[i]==id?'block':'none');
      }
    }
    function $(id) {
      return document.getElementById(id);
    }
    function openForgotDialog() {
      showPage('forgot');
    }
    function startForgotPassword() {
      customer.startForgotPassword($('email_forgot').value, localStorage.encrSolution, $('solution_forgot').value, function(err, data) {
        alert(err);
        alert(data);
      });
    }
    function step1() {
      localStorage.fullName = $('fn').value;
      localStorage.email = $('email').value;
      localStorage.pwd = $('pwd').value;
      showPage('second');
    }
    function genCaptcha() {
      customer.requestCaptcha(function(uri, encrSolution, encrSalt) {
        $('captcha').setAttribute('src', uri);
        $('captcha_forgot').setAttribute('src', uri);
        localStorage.encrSolution = encrSolution;
        localStorage.encrSalt = encrSalt;
      });
    }
    function register() {
      customer.requestAccount(($('agree').checked?$('tos').innerHTML:''), localStorage.email, localStorage.pwd, localStorage.encrSolution, $('solution').value, $('host').value, function(err, result) {
        if(err) {
          alert(err);
        } else {
          showSettings(result);
        }
      });
    }
    function signIn() {
      customer.getSession($('email1').value, $('pwd1').value, function(err, result) {
        if(err) {
          alert(err);
        } else {
          if($('remember').checked) {
            localStorage.sessionKey = result;
          }
          showSettings(result);
        }
      });
    }
    function showSettings(sessionKey) {
      customer.getSettings(sessionKey, function(err, obj) {
        if(err) {
          alert(err);
        } else {
          $('settingsEmail').value = obj.email;
          if(obj.emailValidated) {
            $('validateEmail').style.display='none';
          }
        }
      });
      sessionStorage.sessionKey = sessionKey;
      showPage('settings');
    }
    function changePwd() {
      customer.changePassword(sessionStorage.sessionKey, $('currentPwd').value, $('newPwd').value, function(err) {
        if(err) {
          alert(err);
        } else {
          alert('password changed!');
        }
      });
    }
    function completeForgotPassword() {
      //a password reset session is somehow special in that it doesn't require retyping your current password:
      customer.completeForgotPassword(sessionStorage.resetPwd, $('password_reset').value, function(err, sessionKey) {
        if(err) {
          alert(err);
        } else {
          showSettings(sessionKey);
          alert('Password reset. Now remember it, ok? ;)');
        }
      });
    }
    function deleteAccount() {
      customer.deleteAccount(sessionStorage.sessionKey, $('currentPwd').value, function(err) {
        if(err) {
          alert(err);
        } else {
          logout();
          console.log('Sad to see you go. Have a nice life. Over and out!');
        }
      });
    }
    function logout() {
      showPage('first');
      delete localStorage.sessionKey;
      delete sessionStorage.sessionKey;
    }
    backtofront.connect('wss://'+location.host+'/sock/websocket', 'my_secret', function() {
      if(location.hash.length) {
        //someone is trying to use a token, log out the current session:
        delete sessionStorage.sessionKey;
        //even if it was remembered:
        delete localStorage.sessionKey;
        var parts = location.hash.substring(1).split(':');
        location.hash = '';
        if(parts[0]=='verify') {
          customer.completeVerifyEmail(parts[1], function(err, sessionKey) {
            if(err) {
              showPage('first');
              alert(err);
            } else {
              showSettings(sessionKey);
              alert('email address verified, thank you!');              
            }
          });
        } else if(parts[0]=='reset_password') {
          sessionStorage.resetPwd = parts[1];
          showPage('resetPwd');
        } else if(parts[0]=='email_change') {
          customer.completeChangeEmail(parts[1], function(err, sessionKey) {
            if(err) {
              showPage('first');
              alert(err);
            } else {
              showSettings(sessionKey);
              alert('email address changed!');
            }
          });
        } else {
          alert('ignoring hash '+JSON.stringify(parts));
          showPage('first');
        }
      } else {
        if(localStorage.sessionKey) {
          showSettings(localStorage.sessionKey);
        } else if(sessionStorage.sessionKey) {
          showSettings(sessionStorage.sessionKey);
        } else {
          showPage('first');
        }
      }
      genCaptcha();
      //fillSettings();
    });
  </script>
</html>
