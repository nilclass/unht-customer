<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
  </head>
  <body style="width:800px;margin:0px auto">
    <div id="first">
      <div style="background:grey;width:350px;float:right;margin-top:50px">
        <p style="margin-left:30px"><input id="email1" placeholder="Your website or email"/></p>
        <p style="margin-left:30px"><input id="pwd1" placeholder="Password" type="password" />
            <input type="submit" value="Sign in" onclick="signIn();"/></p>
        <p style="margin-left:30px"><input type="checkbox"/>Remember me | Forgot password?</p>
      </div>
      <p style="clear:right; float:left; width:300px"><strong>Welcome to the web.</strong> Connect with friends and the world around you.
      </p>
      <ul style="clear:left; float:left; width:300px">
        <li>See photos and updates</li>
        <li>Share what's new</li>
        <li>Find more</li>
      </ul>
      <div style="background:grey; width:350px;float:right;clear:right;margin-top:50px">
        <p style="margin-left:30px"><strong>New to the web?</strong> Sign up</p>
        <p style="margin-left:30px"><input placeholder="Full name" id="fn" /></p>
        <p style="margin-left:30px"><input placeholder="Email" id="email" /></p>
        <p style="margin-left:30px"><input type="password" placeholder="Password" id="pwd" /></p>
        <p style="margin-right:30px;float:right"><a href="more.html">learn more</a>
             <input type="submit" value="Sign up for the web" onclick="step1();"/></p>
      </div>
    </div>
    <div style="display:none" id="second">
      <p><input placeholder="yourname" id="host" /><strong>.un.ht</strong></p>
      <p><strong>Terms of Service:</strong></p>
      <p><textarea id="tos" readOnly=true>Be nice!</textarea></p>
      <p><input type="checkbox" id="agree">I agree to the Terms of Service</p>
      <input type="submit" value="regen" onclick="genCaptcha();" />
      <img id="captcha" />
      <input id="solution" />
      <input type="submit" value="register" onclick="register();" />
    </div>
    <div style="display:none" id="settings">
      <h1 id="welcome">Welcome to your unhosted customer account</h1>
      <p>
        <input id="settingsEmail" /><input type="submit" value="Resend validation email" id="validateEmail"/>
        <input type="submit" value="Change" onclick="changeEmail();" />
      </p>
      <p>
        Current: <input id="currentPwd" type="password" />
        New: <input id="newPwd" type="password" />
        <input type="submit" value="Change password" onclick="changePwd();" />
        <input type="submit" value="Delete account" style="background:red" onclick="deleteAccount();" />
      </p>
    </div>
  </body>
  <script src="backtofront.js"></script>
  <script>
    function $(id) {
      return document.getElementById(id);
    }
    function step1() {
      localStorage.fullName = $('fn').value;
      localStorage.email = $('email').value;
      localStorage.pwd = $('pwd').value;
      $('first').style.display='none';
      $('second').style.display='block';
    }
    function genCaptcha() {
      customer.requestCaptcha(function(uri, encrSolution, encrSalt) {
        $('captcha').setAttribute('src', uri);
        localStorage.encrSolution = encrSolution;
        localStorage.encrSalt = encrSalt;
      });
    }
    function register() {
      customer.requestAccount(($('agree').checked?$('tos').innerHTML:''), localStorage.email, localStorage.pwd, localStorage.encrSolution, $('solution').value, $('host').value, function(err, result) {
        if(err) {
          alert(err);
        } else {
          showSettings(result);
        }
      });
    }
    function signIn() {
      customer.getSession($('email1').value, $('pwd1').value, function(err, result) {
        if(err) {
          alert(err);
        } else {
          showSettings(result);
        }
      });
    }
    function showSettings(sessionKey) {
      customer.getSettings(sessionKey, function(err, obj) {
        if(err) {
          alert(err);
        } else {
          $('settingsEmail').value = obj.email;
          if(obj.emailValidated) {
            $('validateEmail').style.display='none';
          }
        }
      });
      localStorage.sessionKey = sessionKey;
      $('first').style.display='none';
      $('second').style.display='none';
      $('settings').style.display='block';
    }
    function changeEmail() {
      customer.changeEmail(localStorage.sessionKey, $('currentPwd').value, $('settingsEmail').value, function(err) {
        alert(err);
      });
    }
    function changePwd() {
      customer.changePassword(localStorage.sessionKey, $('currentPwd').value, $('newPwd').value, function(err) {
        alert(err);
      });
    }
    function deleteAccount() {
      customer.deleteAccount(localStorage.sessionKey, $('currentPwd').value, function(err) {
        alert(err);
      });
    } 
    backtofront.connect('wss://'+location.host+'/sock/websocket', 'my_secret', function() {
      genCaptcha();
      //fillSettings();
    });
  </script>
</html>
